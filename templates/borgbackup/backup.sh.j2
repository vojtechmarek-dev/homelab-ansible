    
#!/bin/bash
# A script to perform Borg backups, managed by Ansible.

# Exit immediately if a command exits with a non-zero status.
set -e

# --- Configuration (Pulled from Ansible) ---
# The BORG_PASSPHRASE is loaded by the cron job from the env file.
export BORG_REPO='{{ backup_repo_path }}'

# --- Optional: Healthchecks.io Integration ---
# This variable is read from the Ansible Vault.
HEALTHCHECK_URL="{{ secrets.healthcheck_borg_url | default('') }}"

echo "Starting Borg backup..."

# Create a new backup archive.
# {now} is a Borg placeholder for the current timestamp.
# --filter AME tells Borg to respect .borgignore files (similar to .gitignore).
borg create \
    --verbose \
    --stats \
    --list \
    --filter AME \
    --compression lz4 \
    ::'backup-{now:%Y-%m-%d_%H-%M-%S}' \
    {% for source in backup_sources %}
    {{ source }} \
    {% endfor %}

echo "Backup created successfully. Pruning old backups..."

# Prune old archives to save space according to the retention policy.
borg prune \
    --verbose \
    --list \
    --keep-daily=7 \
    --keep-weekly=4 \
    --keep-monthly=6 \
    $BORG_REPO

echo "Backup and prune complete."

# Ping the healthcheck URL to report success.
# The script will exit on error before this line is reached.
if [ -n "$HEALTHCHECK_URL" ]; then
    echo "Pinging healthcheck..."
    curl -fsS --retry 3 "$HEALTHCHECK_URL" > /dev/null
fi

echo "Borg backup script finished."